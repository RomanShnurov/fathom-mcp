FROM python:3.12-slim

# Install system dependencies and filter tools
RUN apt-get update && apt-get install -y \
    # ugrep
    ugrep \
    # PDF tools
    poppler-utils \
    # Document converters
    pandoc \
    antiword \
    catdoc \
    # Data tools
    jq \
    libxml2-utils \
    # Build tools
    git \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
WORKDIR /app
COPY pyproject.toml README.md ./
COPY src/ ./src/

# Install package with dev dependencies
RUN pip install --no-cache-dir -e ".[dev]"

# Copy tests
COPY tests/ ./tests/
COPY config.example.yaml ./

# Run tests
CMD ["pytest", "tests/", "-v", "--cov=src/contextfs", "--cov-report=term-missing"]
