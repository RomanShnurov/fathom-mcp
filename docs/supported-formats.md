# Supported Document Formats

## Overview

fathom-mcp supports searching and reading multiple document formats through the ugrep search engine and external filter tools. This document describes all supported formats, required tools, and installation instructions.

## Format Support Matrix

| Format | Extensions | Filter Tool | Required | Platform | Status |
|--------|------------|-------------|----------|----------|--------|
| **PDF** | .pdf | pdftotext | Yes | All | âœ… Default |
| **Markdown** | .md, .markdown | - | No | All | âœ… Default |
| **Text** | .txt, .rst | - | No | All | âœ… Default |
| **CSV** | .csv | - | No | All | âœ… Default |
| **Word (modern)** | .docx | pandoc | No | All | ðŸ”§ Optional |
| **Word (legacy)** | .doc | antiword | No | Linux/macOS | ðŸ”§ Optional |
| **OpenDocument** | .odt | pandoc | No | All | ðŸ”§ Optional |
| **EPUB** | .epub | pandoc | No | All | ðŸ”§ Optional |
| **HTML** | .html, .htm | pandoc | No | All | ðŸ”§ Optional |
| **RTF** | .rtf | pandoc | No | All | ðŸ”§ Optional |
| **JSON** | .json | jq | No | All | ðŸ”§ Optional |
| **XML** | .xml | pandoc | No | All | ðŸ”§ Optional |

**Legend**:
- âœ… Enabled by default (no external tools needed, or tool commonly installed)
- ðŸ”§ Disabled by default (requires external tool installation and configuration)

## Installation

### Quick Start (Recommended)

For most use cases, install **pandoc** and **jq**:

```bash
# macOS
brew install pandoc jq

# Linux (Ubuntu/Debian)
sudo apt update
sudo apt install pandoc jq

# Windows (Chocolatey)
choco install pandoc jq
```

This enables: DOCX, ODT, EPUB, HTML, RTF, JSON, XML support.

### Full Installation

For complete format support including legacy .doc files:

```bash
# macOS
brew install pandoc jq antiword poppler

# Linux (Ubuntu/Debian)
sudo apt install pandoc jq antiword poppler-utils

# Windows (Chocolatey)
choco install pandoc jq poppler
# Note: antiword limited support on Windows
```

### Verification

After installation, verify tools are available:

```bash
python scripts/verify-filters.py
```

Expected output:
```
 Fathom MCP Filter Tool Verification

âœ… Installed     pdftotext       - Formats: PDF
âœ… Installed     pandoc          - Formats: DOCX, ODT, EPUB, HTML, RTF, XML
âœ… Installed     jq              - Formats: JSON
âš ï¸  Optional     antiword        - Install: antiword

Summary:
  Installed tools: 3/4
  âœ… All required tools installed
```

## Configuration

### Enable Formats

Edit `config.yaml` to enable desired formats:

```yaml
formats:
  word_docx:
    enabled: true  # Enable DOCX support

  html:
    enabled: true  # Enable HTML support

  json:
    enabled: true  # Enable JSON support
```

### Custom Filter Commands

Advanced users can customize filter commands:

```yaml
formats:
  html:
    enabled: true
    filter: "html2text -"  # Use html2text instead of pandoc
    extensions: [".html", ".htm"]
```

## How It Works

### ugrep+ and .ugrep Configuration

fathom-mcp uses ugrep's `ug+` command which automatically applies document filters based on file extensions.

When the server starts, it generates a `.ugrep` configuration file in your system temp directory:

```
### Generated by fathom-mcp MCP server
### Knowledge root: /path/to/documents

# Document filters
--filter="pdf:pdftotext % -"
--filter="docx,odt,epub,rtf:pandoc --wrap=preserve -t plain % -o -"
--filter="html,htm:pandoc --wrap=preserve -f html -t plain % -o -"
--filter="json:jq -r '.'"

# Performance settings
--context=3
--line-number
--with-filename
```

### Search Workflow

1. User searches for "machine learning"
2. fathom-mcp runs: `ug+ -% "machine learning" /path/to/documents`
3. ugrep reads `.ugrep` config
4. For each file type:
   - .txt, .md, .csv: Search directly
   - .pdf: Filter through `pdftotext`, then search
   - .docx: Filter through `pandoc`, then search
5. Results returned with file paths and context

## Troubleshooting

### Filter tool not found

**Error**: `filter tool 'pandoc' not found`

**Solution**:
1. Install pandoc: `brew install pandoc` (macOS) or `apt install pandoc` (Linux)
2. Verify: `pandoc --version`
3. Restart fathom-mcp server

### Timeout errors

**Error**: `Filter timeout reading document.docx (>30s)`

**Solution**:
Increase timeout in `config.yaml`:
```yaml
security:
  filter_timeout_seconds: 60  # Increase to 60 seconds
```

### Empty search results

**Issue**: No results even though document contains search term

**Possible causes**:
1. Format not enabled in config
2. Filter tool not installed
3. .ugrep file not generated

**Solution**:
```bash
# Check config
python scripts/verify-filters.py

# Verify .ugrep file exists (in temp directory)
# Will be regenerated on next server start

# Enable format in config.yaml
```

### Permission errors

**Error**: `Permission denied writing .ugrep`

**Solution**:
Ensure fathom-mcp has write permission to system temp directory. The `.ugrep` file is now written to the temp directory to avoid modifying your document directory.

## Security Considerations

### Filter Command Validation

All filter commands are validated before execution:
- Must be in whitelist (security.allowed_filter_commands)
- Commands use stdin (no file path exposure)
- Timeout enforcement prevents hanging processes
- Memory limits (platform-dependent)

### Safe Filter Commands

fathom-mcp uses safe, well-established filter tools:
- **pdftotext**: From poppler-utils, mature and secure
- **pandoc**: Widely used, we only use plain text output
- **antiword**: Simple tool, text output only
- **jq**: JSON processor, identity filter only

### Recommendations

1. Keep filter tools updated
2. Monitor for security advisories (CVEs)
3. Use whitelist mode (default)
4. Review .ugrep file periodically
5. Consider sandboxing in production (Docker)

## Performance

### Typical Performance

| Format | File Size | Filter Time | Notes |
|--------|-----------|-------------|-------|
| PDF | 1 MB | ~0.5s | Fast with pdftotext |
| DOCX | 500 KB | ~1s | Depends on pandoc |
| HTML | 100 KB | ~0.3s | Very fast |
| JSON | 1 MB | ~0.2s | Fast with jq |

### Optimization Tips

1. **Enable only needed formats**: Fewer filters = faster searches
2. **Use file indexing**: For very large collections
3. **Increase timeout for large files**: Adjust filter_timeout_seconds
4. **Consider parallelism**: ugrep supports multi-threading

## FAQ

**Q: Can I add custom file formats?**

A: Yes, add to `formats` in config.yaml with appropriate filter command.

**Q: Do I need all filter tools installed?**

A: No, only install tools for formats you need. Others will be disabled automatically.

**Q: Can I use different filter tools (e.g., html2text instead of pandoc)?**

A: Yes, customize filter commands in config.yaml.

**Q: Will this slow down my searches?**

A: Minimal impact (<5%) if filters are properly installed and configured.

**Q: Can I disable filter caching?**

A: Search results are cached by default. Filters execute on-demand.

## Resources

- [ugrep Documentation](https://ugrep.com/)
- [Pandoc Manual](https://pandoc.org/MANUAL.html)
- [jq Manual](https://stedolan.github.io/jq/manual/)
- [Poppler Utils](https://poppler.freedesktop.org/)
